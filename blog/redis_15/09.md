# [15天玩转redis —— 第九篇 发布/订阅模式][0] 

本系列已经过半了，这一篇我们来看看redis好玩的发布订阅模式，其实在很多的MQ产品中都存在这样的一个模式，我们常听到的一个例子

就是邮件订阅的场景，什么意思呢，也就是说100个人订阅了你的博客，如果博主发表了文章，那么100个人就会同时收到通知邮件，除了这个

场景还能找到其他场景么，当然有啦，你想想，如果你要在内存里面做一个读写分离的程序，为了维持数据的完整性，你是不是需要保证在写入

的时候，也要分发到各个读内存的程序中呢？所以说场景还是很多的，在于你的挖掘~~~ 下面还是从基本命令入手：

一：命令简介

![][1]

从redis手册上面可以看到，其实“发布、订阅”模式才区区6个命令，下面听我一一解说下哈~~~

1. subscribe

    SUBSCRIBE channel [channel ...]
    
    订阅给定的一个或多个频道的信息。

从上面的官方解释上来看，它的玩法有一点像现实生活中我们听收音机一个道理，要想听收音机，我们要做什么？肯定就是调频啦，只有在正

确的频道上面，我们才能听得到好听的节目，所以说subscribe首先要订阅一个频道（channel），下面我举个例子，开两个client，分别订阅着

msg 这个频道，比如下面这样：

![][2]

2.publish

到现在为止，这两个subscibe都在监视着msg这个频道，接下来，如果msg频道有消息传出，必定会被subscribe接收到，先我们还是看看

redis手册上怎么用这个命令。

    PUBLISH channel message
    
    将信息 message 发送到指定的频道 channel 。

看到上面命令的用法，我也就放心了。

![][3]

看到么有，publish在msg这个频道上面发送消息后，被subscribe监视到了，然后就被分别打印输出了，好了，到现在为止，最基本的发布

订阅模式就是这样，是不是很简单哈。。。其实呢？？？ 也就是这么简单呐，但是呢，有时候我们还有这样一个需求，就是我能不能模糊匹

配key呢？？？举了例子，就是要求订阅china为前缀的所有频道，如果这样也可以做到的话，那确实是很牛逼啦。。。我要是回答的话，当

然啦，强大的redis自然会做到这一点，它提供了的命令就是：Psubscribe。

3. Psubscribe

    PSUBSCRIBE pattern [pattern ...]
    
    订阅一个或多个符合给定模式的频道。
    
    每个模式以 * 作为匹配符，比如 it* 匹配所有以 it 开头的频道( it.news 、 it.blog 、 it.tweets 等等)， news.* 匹配所有以 news. 开头的频道( news.it 、 news.global.today 等等)，诸如此类。

看到上面的解释，你心里可能就在想，这不就是正则匹配么。。。而且前缀“P”就是Pattern的意思，对吧，接下来我就订阅一下所有china为

前缀的channel。

![][4]

好了，最常用的也就是这三个命令，接下来我们简单分析一下代码。

二： 源码简单分析

其实redis的发布订阅模式，使用RedisServer下面的 pubsub_channels字典 和 pubsub_patterns数组存放的，所有的操作代码都

在pubsub.c文件下，如下图：

![][5]

1. pubsub_channels

可以看到，它是一个字典结构，通过注释你应该明白，它的key为channel，value为list。

2. pubsub_patterns

同样从注释中，你可以看到，其实它就是存放模式匹配的subscribe的clients列表，对吧，用一个list数组实现。

3. subcribeCommand

通过下面的代码，你是不是在脑子里面很有轮廓了？？？其实这个pubsub_channels果然就是key=channel，value=list的存放模式，

这个 list就是所谓的clients列表，这样的话，你就知道了哪些key挂了哪些clients，对吧，如果再publish的话，只需要遍历一下这个 list就知

道结果了。

![][6]

4. publishCommand

先前也说了，publish的原理很简单，就是找到字典中的channel这个key，获取到clients之后，遍历client的来发送信息。

![][7]

同样的道理，pubsub_patterns也是差不多的实现，只要大家简单看一下pubsub.c这个源代码文件，差不多都会懂得，没啥好说的，

希望这篇对你有用~

[0]: http://www.cnblogs.com/huangxincheng/p/5002794.html
[1]: http://images2015.cnblogs.com/blog/214741/201511/214741-20151128135758171-2042515287.jpg
[2]: http://images2015.cnblogs.com/blog/214741/201511/214741-20151128140604234-590887359.png
[3]: http://images2015.cnblogs.com/blog/214741/201511/214741-20151128141147796-1161576778.jpg
[4]: http://images2015.cnblogs.com/blog/214741/201511/214741-20151128144325859-32965398.png
[5]: http://images2015.cnblogs.com/blog/214741/201511/214741-20151128145433124-1495568593.jpg
[6]: http://images2015.cnblogs.com/blog/214741/201511/214741-20151128150311718-232150396.jpg
[7]: http://images2015.cnblogs.com/blog/214741/201511/214741-20151128150842327-2084783583.png