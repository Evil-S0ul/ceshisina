# 【PHPsocket编程专题(理论篇)】初步理解TCP/IP、Http、Socket

PHP- - -

## 前言

我们平时说的最多的socket是什么呢，实际上socket是对TCP/IP协议的封装，Socket本身并不是协议，而是一个调用接口(API)。那TCP/IP又是什么呢？TCP/IP是ISO/OSI的浓缩版本，那ISO/OSI又是什么呢。。。接下来我们就进入枯燥的理论篇吧

先说一下，关于这几个概念特别是TCP/IP和HTTP，讲解它们的书，随便拿出一本都厚到可以砸死人，所以本文仅仅是浅显的概括一下，并且还有很多的概念我都不太明白，先做个记录吧等后续有深入的机会再回来。也希望有朋友能在留言中指点一二。

### ISO/OSI

OSI（Open System Interconnect），即开放式系统互联。 一般都叫OSI参考模型，是ISO（国际标准化组织）组织在1985年研究的网络互联模型。该体系结构标准定义了网络互连的七层框架（物理层、数据链路层、网络层、传输层、会话层、表示层和应用层），即ISO开放系统互连参考模型。**注意这仅仅是一个参考模型，实际用得更多的是更成熟的tcp/ip4层模型**。

![image002.gif-6.5kB][0]

上三层总称应用层负责用户输出输入的，是控制软件方面的。下四层总称数据流层，负责数据传输的，是用来管理硬件的。

#### **OSI参考模型中的数据传输过程**

在OSI参考模型中，不同主机对等层之间按相应协议进行通信，同一主机不同层之间通过接口进行通信。除了最低层的物理层是通过传输介质进行物理数据传输外，其他对等层之间的通信均为逻辑通信。在这个模型中，每一层将上层传递过来的通信数据加上若干控制位后再传递给下一层，最终由物理层传递到对方物理层，再逐级上传，从而实现对等层之间的逻辑通信，如下图所示。

![image004.gif-6.2kB][1]

#### 物理层

物理层是OSI参考模型的最低层，它利用传输介质为数据链路层提供物理连接。它主要关心的是通过物理链路从一个节点向另一个节点传送比特流，物理链路可能是铜线、卫星、微波或其他的通讯媒介。它关心的问题有：多少伏电压代表1？多少伏电压代表0？等问题。总的来说物理层关心的是链路的机械、电气、功能和规程特性。作用是通过传输介质发送和接收二进制比特流。

#### 数据链路层

数据链路层是为网络层提供服务的，解决两个相邻结点之间的通信问题，传送的协议数据单元称为数据帧。数据帧中包含物理地址（又称MAC地址）用mac地址确认访问的对象是谁(发件人和收件人)、控制码、数据及校验码等信息。该层的主要作用是通过校验、确认和反馈重发等手段，将不可靠的物理链路转换成对网络层来说无差错的数据链路。此外，数据链路层还要协调收发双方的数据传输速率，即进行流量控制，以防止接收方因来不及处理发送方来的高速数据而导致缓冲器溢出及线路阻塞。

#### 网络层

网络层是为传输层提供服务的，传送的协议数据单元称为数据包或分组。该层的主要作用是解决如何使数据包通过各结点传送的问题，即通过路径选择算法（路由）将数据包送到目的地。另外，为避免通信子网中出现过多的数据包而造成网络阻塞，需要对流入的数据包数量进行控制（拥塞控制）。当数据包要跨越多个通信子网才能到达目的地时，还要解决网际互连的问题。ip地址的写入就在网络层上的。

#### 传输层

确定通过哪一个协议来传递，同样传输层也拥有数据校验能力，浏览控制功能，比如网络卡了就稍微缓缓传输等，传输层tcp和udp，每个传输协议都有65355个端口，然后确认端口号，为上层协议提供**端到端**的可靠和透明的数据传输服务，传输层传送的协议数据单元称为段或报文。

#### 会话层

会话层主要功能是管理和协调不同主机上各种进程之间的通信（对话），即负责建立、管理和终止应用程序之间的会话。会话层得名的原因是它很类似于两个实体间的会话概念。例如，一个交互的用户会话以登录到计算机开始，以注销结束。

#### 表示层

表示层**处理流经结点的数据编码的表示方式问题**，以保证一个系统应用层发出的信息可被另一系统的应用层读出。二进制数据过来以后，究竟是图片，音乐，电影，文字呢?这个就由表示层来搞定，另外在由应用层输入到表示层的时候，表示层又把文字，音乐等数据转换为二进制数据

#### 应用层

应用层是OSI参考模型的最高层，是用户与网络的接口。该层通过应用程序来完成网络用户的应用需求，如文件传输、收发电子邮件等。   
给用户提供服务的接口，也就是我们开发用于交互的程序;

![f60169dfcd358e1ccdbf1a61.jpg-84.6kB][2]

通过初步的了解，我知道IP协议对应于网络层，TCP协议对应于传输层，而HTTP协议对应于应用层，三者从本质上来说没有可比性，socket则是对TCP/IP协议的封装和应用(程序员层面上)。

## TCP/IP

TCP/IP模型实际上是OSI模型的一个浓缩版本，它只有四个层次。

![d009b3de9c82d158935225be800a19d8bd3e42e8.jpg-13kB][3]

手机能够使用联网功能是因为手机底层实现了TCP/IP协议，可以使手机终端通过无线网络建立TCP连接。TCP协议可以对上层网络提供接口(socket)，使上层网络数据的传输建立在“无差别”的网络之上。

建立起一个TCP连接需要经过“三次握手”:   
第一次握手：客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；   
第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；   
第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。

握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP连接一旦建立，在通信双方中的任何一方主动关闭连接之前，TCP 连接都将被一直保持下去。断开连接时服务器和客户端均可以主动发起断开TCP连接的请求，断开过程需要经过“四次握手”（过程就不细写了，就是服务器和客户端交互，最终确定断开）

**以对话的形式来比喻这个过程：“客户端：你在酒店吗，在的话我就来了。服务端：我在酒店的，房间是308号，速来！客户端：好的，我来了，你等我哦，么么哒”。**然后客户端才真正的去找服务端；

### TCP和UDP的区别

一、TCP是面向链接的，虽然说网络的不安全不稳定特性决定了多少次握手都不能保证连接的可靠性，但TCP的三次握手在最低限度上(实际上也很大程度上保证了)保证了连接的可靠性;而UDP不是面向连接的，UDP传送数据前并不与对方建立连接，对接收到的数据也不发送确认信号，发送端不知道数据是否会正确接收，当然也不用重发，所以说UDP是无连接的、不可靠的一种数据传输协议。   
二、也正由于1所说的特点，使得UDP的开销更小数据传输速率更高，因为不必进行收发数据的确认，所以UDP的实时性更好。知道了TCP和UDP的区别，就不难理解为何采用TCP传输协议的MSN比采用UDP的QQ传输文件慢了，但并不能说QQ的通信是不安全的，因为程序员可以手动对UDP的数据收发进行验证，比如发送方对每个数据包进行编号然后由接收方进行验证啊什么的，即使是这样，UDP因为在底层协议的封装上没有采用类似TCP的“三次握手”而实现了TCP所无法达到的传输效率。

## HTTP

HTTP属于TCP/IP应用层协议,应用层协议有很多，比如HTTP、FTP、TELNET等，也可以自己定义应用层协议。   
**WEB使用HTTP协议作应用层协议，以封装HTTP文本信息，然后使用TCP/IP做传输层协议将它发到网络上。**  
HTTP协议是建立在请求/响应模型上的。首先由客户建立一条与服务器的TCP链接，并发送一个请求到服务器，请求中包含请求方法、URI、协议版本以及相关的MIME样式的消息。服务器响应一个状态行，包含消息的协议版本、一个成功和失败码以及相关的MIME式样的消息。   
HTTP/1.0为每一次HTTP的请求/响应建立一条新的TCP链接，因此一个包含HTML内容和图片的页面将需要建立多次的短期的TCP链接。一次TCP链接的建立将需要3次握手。但HTTP/1.1里面有所改变,可以在一次连接中处理多个请求，并且多个请求可以重叠进行，不需要等待一个请求结束后再发送下一个请求。   
由于HTTP在每次请求结束后都会主动释放连接，因此HTTP连接是一种“短连接”，要保持客户端程序的在线状态，需要不断地向服务器发起连接请求。通常的做法是即时不需要获得任何数据，客户端也保持每隔一段固定的时间向服务器发送一次“保持连接”的请求，服务器在收到该请求后对客户端进行回复，表明知道客户端“在线”。若服务器长时间无法收到客户端的请求，则认为客户端“下线”，若客户端长时间无法收到服务器的回复，则认为网络已经断开。   
我们的网站和APP开发都是基于http协议来的,常用的get和post都是属于http协议中的方法,在浏览器中输入网址到打开网站就是一个http的旅程:[http://blog.csdn.net/saiwaifeike/article/details/8789624][4]

## SOCKET

socket的英文原义是“孔”或“插座”。作为BSD UNIX的进程通信机制，取后一种意思。通常也称作”套接字”，用于描述IP地址和端口，是一个通信链的句柄。   
**Socket是应用层与TCP/IP协议族通信的中间软件抽象层，它是一组接口。**  
![05172918-d2b39f21a08a4550b4e3c5bce482a220.jpg-36.6kB][5]

通过Socket，我们才能使用TCP/IP协议。实际上，Socket跟TCP/IP协议没有必然的联系。Socket编程接口在设计的时候，就希望也能适应其他的网络协议。所以说，Socket的出现只是使得程序员更方便地使用TCP/IP协议栈而已，是对TCP/IP协议的抽象，从而形成了我们知道的一些最基本的函数接口，比如create、listen、connect、accept、send、read和write等等。

![05172951-a955fce4e5d04082828e717fe0e102f9.jpg-26kB][6]

先从服务器端说起。服务器端先初始化Socket，然后与端口绑定(bind)，对端口进行监听(listen)，调用accept阻塞，等待客户端连接。在这时如果有个客户端初始化一个Socket，然后连接服务器(connect)，如果连接成功，这时客户端与服务器端的连接就建立了。客户端发送数据请求，服务器端接收请求并处理请求，然后把回应数据发送给客户端，客户端读取数据，最后关闭连接，一次交互结束。

套接字（socket）是通信的基石，是支持TCP/IP协议的网络通信的基本操作单元。它是网络通信过程中端点的抽象表示，包含进行网络通信必须的五种信息：连接使用的协议，本地主机的IP地址，本地进程的协议端口，远地主机的IP地址，远地进程的协议端口。

### SOCKET连接与TCP连接

创建Socket连接时，可以指定使用的传输层协议，Socket可以支持不同的传输层协议（TCP或UDP），当使用TCP协议进行连接时，该Socket连接就是一个TCP连接。

### Socket连接与HTTP连接

由于通常情况下Socket连接就是TCP连接，因此Socket连接一旦建立，通信双方即可开始相互发送数据内容，直到双方连接断开。但在实际网络应用中，客户端到服务器之间的通信往往需要穿越多个中间节点，例如路由器、网关、防火墙等，大部分防火墙默认会关闭长时间处于非活跃状态的连接而导致 Socket 连接断连，因此需要通过轮询告诉网络，该连接处于活跃状态。   
而HTTP连接使用的是“请求—响应”的方式，不仅在请求时需要先建立连接，而且需要客户端向服务器发出请求后，服务器端才能回复数据。   
**很多情况下，需要服务器端主动向客户端推送数据，保持客户端与服务器数据的实时与同步。此时若双方建立的是Socket连接，服务器就可以直接将数据传送给客户端；若双方建立的是HTTP连接，则服务器需要等到客户端发送一次请求后才能将数据传回给客户端，因此，客户端定时向服务器端发送连接请求，不仅可以保持在线，同时也是在“询问”服务器是否有新的数据，如果有就将数据传给客户端。**

[0]: ../img/image002.gif
[1]: ../img/image004.gif
[2]: ../img/f60169dfcd358e1ccdbf1a61.jpg
[3]: ../img/d009b3de9c82d158935225be800a19d8bd3e42e8.jpg
[4]: http://blog.csdn.net/saiwaifeike/article/details/8789624
[5]: ../img/05172918-d2b39f21a08a4550b4e3c5bce482a220.jpg
[6]: ../img/05172951-a955fce4e5d04082828e717fe0e102f9.jpg